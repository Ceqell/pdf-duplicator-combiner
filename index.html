<!--
Copyright 2026 Khonthee Jaroensiriphan

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Offline PDF Duplicator & Combiner - Secure & Private</title>
    
    <meta name="description" content="A free, secure, and offline PDF tool. Duplicate pages, combine PDFs, and reorder pages entirely in your browser. No file uploads, no sign-up required.">
    
    <link rel="canonical" href="https://ceqell.github.io/pdf-duplicator-combiner/" />
    
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
	<link rel="icon" type="image/png" href="icon-192.png">
	
    <link href="styles.css?v=1.1.2-5" rel="stylesheet">
    <script src="js/lucide.min.js"></script>
    <script src="js/pdf-lib.min.js"></script>
    <script src="js/pdf.min.js"></script>
    <script src="js/Sortable.min.js"></script>

	<meta name="google-site-verification" content="m10O6Nz7K4x2ZMW1C92Y7fpEgkKTgkgmVZg5Tcas910" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Dragging Styles */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: #fff; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transform: scale(1.02); }

        .pdf-page-card:active { transform: scale(0.98); }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-enter { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal-active { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* --- LIST VIEW STYLES --- */
        /* When .list-view is applied to the container, we change the child card layout */
        .list-view .pdf-page-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            height: auto;
            padding: 0.5rem;
            gap: 1rem;
        }

        .list-view .pdf-page-card .img-container {
            width: 3rem; /* Small thumbnail */
            height: 4rem;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        
        /* Hide the page number badge in list view, we'll show a text label instead */
        .list-view .pdf-page-card .page-badge { display: none; }
        
        /* Show the text label only in list view */
        .list-view .pdf-page-card .list-label { display: block; }
        .pdf-page-card .list-label { display: none; }

        .list-view .pdf-page-card .controls {
            width: auto;
            margin-left: auto; /* Push to right */
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50 pb-10">

    <nav class="bg-white border-b border-slate-200 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm z-30 shrink-0">
        <div class="flex items-center gap-2.5">
            <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-sm">
                <i data-lucide="layers" class="h-5 w-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg md:text-xl tracking-tight text-slate-900 leading-tight">PDF Duplicator/Combiner</h1>
                <div class="flex items-center gap-1 text-[10px] md:text-xs text-green-600 font-medium">
                    <i data-lucide="shield-check" class="h-3 w-3"></i>
                    <span>Client-Side Only</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="resetApp()" class="hidden text-sm font-medium text-slate-500 hover:text-red-600 px-3 py-2 transition-colors" id="resetBtn">
                Reset
            </button>
            <button id="downloadBtn" onclick="downloadPDF()" disabled class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-medium transition-all shadow-sm active:scale-95 text-sm md:text-base">
                <i data-lucide="download" class="h-4 w-4"></i>
                <span class="hidden md:inline">Download PDF</span>
                <span class="md:hidden">Save</span>
            </button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <div id="uploadOverlay" class="absolute inset-0 z-40 bg-slate-50 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
            <div class="max-w-md w-full text-center">
                <div id="dropZone" class="bg-white rounded-2xl border-2 border-dashed border-slate-300 p-8 md:p-12 cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 transition-all group">
                    <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 group-hover:scale-110 transition-transform">
                        <i data-lucide="file-up" class="h-8 w-8"></i>
                    </div>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-2">Select PDF File(s)</h2>
                    <p class="text-slate-500 text-sm mb-6">Documents are processed locally on your device. No data is ever uploaded.</p>
                    <button class="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-medium shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all w-full md:w-auto">
                        Browse Files
                    </button>
                    <input type="file" id="fileInput" accept="application/pdf" class="hidden" multiple>
                </div>
                <div class="mt-8 text-xs text-slate-400 space-y-2">
    				<p class="max-w-xs mx-auto leading-relaxed"> This <strong>free PDF combiner and duplicator</strong> runs entirely in your browser (Client-Side). 100% private & offline capable.</p>
    				<p>Made and hosted for free at no additional cost.<br> <a href="https://github.com/Ceqell/pdf-duplicator-combiner" class="text-blue-600 hover:text-blue-800 underline transition-colors"> View Source on GitHub</a><br>Licensed under the Apache License 2.0</p>	
				</div>
            </div>
        </div>

        <div id="loadingOverlay" class="hidden absolute inset-0 z-50 bg-white/90 backdrop-blur-sm flex items-center justify-center">
            <div class="text-center">
                <div class="spinner mx-auto mb-4 border-t-blue-600 border-slate-200"></div>
                <h3 class="text-lg font-semibold text-slate-800">Processing PDF(s)</h3>
                <p class="text-slate-500 text-sm mt-1" id="loadingText">Generating thumbnails...</p>
            </div>
        </div>

        <div id="previewModal" class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-sm flex flex-col modal-enter transition-all duration-200">
            <div class="flex justify-between items-center p-4 text-white shrink-0">
                <div class="font-medium text-lg">Page Preview <span id="previewPageNum" class="text-slate-400 text-sm ml-2"></span></div>
                <div class="flex gap-2">
                     <button onclick="closePreview()" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 flex items-center justify-center overflow-auto p-4 relative" id="previewContainer">
                 <div id="previewSpinner" class="spinner border-t-white absolute"></div>
                 <canvas id="previewCanvas" class="shadow-2xl max-w-full max-h-full object-contain"></canvas>
            </div>
            <div class="p-4 flex justify-center gap-4 shrink-0 pb-8">
                <button onclick="changePreviewPage(-1)" class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md transition-colors">
                    <i data-lucide="chevron-left" class="h-6 w-6"></i>
                </button>
                <button onclick="changePreviewPage(1)" class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md transition-colors">
                    <i data-lucide="chevron-right" class="h-6 w-6"></i>
                </button>
            </div>
        </div>

        <div id="sourcePanel" class="hidden w-full md:w-7/12 lg:w-2/3 border-b md:border-b-0 md:border-r border-slate-200 bg-slate-100/50 flex flex-col h-[55%] md:h-full transition-opacity relative group/panel">
            <div class="px-4 py-3 border-b border-slate-200 bg-white flex justify-between items-center sticky top-0 z-10 shadow-sm shrink-0">
                <div class="flex items-center gap-3">
                    <h2 class="font-semibold text-slate-700 text-sm md:text-base flex items-center gap-2">
                        <i data-lucide="grid" class="h-4 w-4 text-blue-500"></i>
                        Source Pages
                    </h2>
                    <span class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500" id="sourcePageCount"></span>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="toggleView()" class="p-1.5 text-slate-500 hover:bg-slate-100 rounded border border-transparent hover:border-slate-200 transition-colors" title="Toggle List/Grid View">
                        <i id="viewIcon" data-lucide="list" class="h-4 w-4"></i>
                    </button>
                    <button id="addAllBtn" onclick="addAllPages()" class="text-xs font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-md transition-colors flex items-center gap-1.5 border border-blue-100">
                        <i data-lucide="copy-plus" class="h-3.5 w-3.5"></i>
                        Add All
                    </button>
                    <!-- NEW BUTTON START -->
                    <button onclick="document.getElementById('fileInput').click()" class="text-xs font-medium bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1.5 rounded-md transition-colors flex items-center gap-1.5 border border-slate-200">
                        <i data-lucide="folder-plus" class="h-3.5 w-3.5"></i>
                            Add PDF
                    </button>
                    <!-- NEW BUTTON END -->
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4" id="sourceContainer">
                <div class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 transition-all" id="sourceGrid"></div>
            </div>
            <button id="sourceScrollBtn" onclick="toggleScroll('source')" class="absolute bottom-4 right-4 z-20 bg-white/90 backdrop-blur border border-slate-300 text-slate-600 p-2.5 rounded-full shadow-lg opacity-0 pointer-events-none transition-all duration-300 hover:bg-blue-50 hover:text-blue-600 hover:scale-110 active:scale-95">
                <span id="sourceScrollDown"><i data-lucide="arrow-down" class="h-5 w-5"></i></span>
                <span id="sourceScrollUp" class="hidden"><i data-lucide="arrow-up" class="h-5 w-5"></i></span>
            </button>
        </div>

        <div id="queuePanel" class="hidden w-full md:w-5/12 lg:w-1/3 bg-white flex flex-col h-[45%] md:h-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-xl z-20 relative">
            <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center sticky top-0 z-10 shrink-0">
                <div>
                    <h2 class="font-semibold text-slate-700 text-sm md:text-base flex items-center gap-2">
                        <i data-lucide="list-ordered" class="h-4 w-4 text-green-600"></i>
                        New Layout
                    </h2>
                    <p class="text-[10px] text-slate-400 hidden md:block">Drag items to reorder</p>
                </div>
                <button onclick="clearQueue()" class="text-xs text-red-600 hover:bg-red-50 px-2 py-1 rounded transition-colors font-medium">Clear All</button>
            </div>

            <div class="flex-1 overflow-y-auto p-3 bg-white relative" id="queueContainer">
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-6 text-center">
                    <i data-lucide="arrow-up-circle" class="h-8 w-8 mb-2 md:hidden"></i>
                    <i data-lucide="arrow-left-circle" class="h-8 w-8 mb-2 hidden md:block"></i>
                    <p class="text-sm font-medium">Tap source pages to add them here</p>
                </div>
                <div class="space-y-2 pb-10" id="queueList"></div>
            </div>
			<div class="p-2 border-t border-slate-200 bg-white text-center">
			<p class="text-[10px] text-slate-400 leading-relaxed">
				Made and hosted for free at no additional cost for online and offline use with <span class="text-red-500">‚ù§Ô∏è</span> by <span class="font-semibold text-slate-600">Khonthee Jaroensiriphan</span> from Thailand üáπüá≠
			</p>
			</div>
            <div class="p-3 md:p-4 border-t border-slate-200 bg-slate-50">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Total Pages:</span>
                    <span id="totalNewPages" class="font-bold text-slate-900 text-base">0</span>
                </div>
            </div>
            <button id="queueScrollBtn" onclick="toggleScroll('queue')" class="absolute bottom-16 right-4 md:bottom-[100px] z-20 bg-white/90 backdrop-blur border border-slate-300 text-slate-600 p-2.5 rounded-full shadow-lg opacity-0 pointer-events-none transition-all duration-300 hover:bg-blue-50 hover:text-blue-600 hover:scale-110 active:scale-95">
                <span id="queueScrollDown"><i data-lucide="arrow-down" class="h-5 w-5"></i></span>
                <span id="queueScrollUp" class="hidden"><i data-lucide="arrow-up" class="h-5 w-5"></i></span>
            </button>
        </div>
    </main>

    <template id="sourcePageTemplate">
        <div class="pdf-page-card bg-white p-2 rounded-lg border border-slate-200 shadow-sm relative cursor-pointer hover:border-blue-400 transition-all select-none group">
            
            <div class="img-container aspect-[1/1.4] bg-slate-100 rounded border border-slate-100 mb-2 overflow-hidden relative">
                <img class="w-full h-full object-contain pointer-events-none transition-opacity duration-300 opacity-0" src="" alt="">
                
                <div class="page-badge absolute top-1 left-1 bg-slate-900/60 text-white text-[9px] px-1.5 rounded">P<span class="page-num"></span></div>
                
                <button class="preview-btn absolute top-1 right-1 bg-white/90 hover:bg-blue-600 hover:text-white text-slate-600 p-1 rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity" title="Full Screen View">
                    <i data-lucide="eye" class="h-3.5 w-3.5"></i>
                </button>
            </div>

            <div class="list-label flex-1">
                <span class="text-sm font-semibold text-slate-700">Page <span class="page-num-text"></span></span>
                <p class="text-[10px] text-slate-400">Tap to add</p>
            </div>

            <div class="controls flex gap-1 h-7">
                <input type="number" min="1" max="99" value="1" class="w-12 text-center text-xs border border-slate-200 rounded focus:border-blue-500 outline-none copies-input bg-slate-50" onclick="event.stopPropagation()">
                <button class="bg-blue-600 text-white px-2 rounded hover:bg-blue-700 active:bg-blue-800 transition-colors add-btn flex items-center justify-center">
                    <i data-lucide="plus" class="h-3 w-3"></i>
                </button>
            </div>
        </div>
    </template>

    <template id="queueItemTemplate">
        <div class="queue-item flex items-center gap-3 bg-white p-2 pr-3 rounded border border-slate-200 shadow-sm cursor-grab active:cursor-grabbing hover:border-blue-300 group touch-manipulation"> 
            <!-- Added 'drag-handle' class and 'p-2' for a bigger touch target -->
            <div class="drag-handle cursor-grab text-slate-300 hover:text-slate-500 p-2 -ml-1 touch-none">
                <i data-lucide="grip-vertical" class="h-4 w-4"></i>
            </div> 
            <div class="h-10 w-8 bg-slate-100 rounded border border-slate-100 overflow-hidden shrink-0 relative group/thumb">
                <img class="w-full h-full object-contain pointer-events-none" src="">
                <div class="absolute inset-0 bg-black/20 hidden group-hover/thumb:flex items-center justify-center cursor-pointer preview-trigger">
                     <i data-lucide="eye" class="h-4 w-4 text-white drop-shadow-md"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-xs font-bold text-slate-700">Page <span class="origin-num"></span></div>
                <div class="text-[10px] text-slate-400 truncate file-name">Original PDF</div>
            </div>
            <button class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors remove-btn">
                <i data-lucide="x" class="h-4 w-4"></i>
            </button>
        </div>
    </template>

    <div id="confirmModal" class="hidden fixed inset-0 z-[70] bg-slate-900/50 backdrop-blur-[2px] flex items-center justify-center modal-enter transition-all duration-200">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100">
                <div class="flex items-center gap-3 mb-4 text-slate-800">
                    <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                        <i data-lucide="help-circle" class="h-6 w-6"></i>
                    </div>
                    <h3 class="text-lg font-bold">Confirm Action</h3>
                </div>
                <p id="confirmMessage" class="text-slate-600 text-sm mb-6 leading-relaxed">
                    Are you sure you want to proceed?
                </p>
                <div class="flex justify-end gap-3">
                    <button id="confirmCancelBtn" class="px-4 py-2 text-slate-500 hover:bg-slate-100 font-medium rounded-lg transition-colors text-sm">
                        Cancel
                    </button>
                    <button id="confirmOkBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors text-sm">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        lucide.createIcons();
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';
        const { PDFDocument } = PDFLib;

        // State
        let sources = []; // Array of { id, name, pdfDoc, pdfJsDoc }
        let queue = [];
        let sortable = null;
        let currentPreviewIndex = 0;
        let currentPreviewSourceId = null;
        let observer = null;
        let isListView = false;

        // Elements
        const els = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            uploadOverlay: document.getElementById('uploadOverlay'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            sourcePanel: document.getElementById('sourcePanel'),
            queuePanel: document.getElementById('queuePanel'),
            queueContainer: document.getElementById('queueContainer'),
            sourceGrid: document.getElementById('sourceGrid'),
            queueList: document.getElementById('queueList'),
            emptyState: document.getElementById('emptyState'),
            totalNewPages: document.getElementById('totalNewPages'),
            downloadBtn: document.getElementById('downloadBtn'),
            resetBtn: document.getElementById('resetBtn'),
            sourceCount: document.getElementById('sourcePageCount'),
            previewModal: document.getElementById('previewModal'),
            previewCanvas: document.getElementById('previewCanvas'),
            previewSpinner: document.getElementById('previewSpinner'),
            previewPageNum: document.getElementById('previewPageNum'),
            viewIcon: document.getElementById('viewIcon'),
            addAllBtn: document.getElementById('addAllBtn')
        };

        // Handlers
        els.dropZone.addEventListener('click', () => els.fileInput.click());
        els.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); els.dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('border-blue-500', 'bg-blue-50'));
        els.dropZone.addEventListener('drop', handleDrop);
        els.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        document.addEventListener('keydown', (e) => {
            if (els.previewModal.classList.contains('modal-active')) {
                if (e.key === 'Escape') closePreview();
                // Simple navigation for preview (stays within same source)
                if (e.key === 'ArrowLeft') changePreviewPage(-1);
                if (e.key === 'ArrowRight') changePreviewPage(1);
            }
        });

        function handleDrop(e) {
            e.preventDefault();
            els.dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
        }

        async function handleFiles(files) {

            if (sources.length > 10) {
                if(!await showConfirm("Loading many large PDFs might slow down your browser. Continue?")) return;
            }

            if (!files || files.length === 0) return;

            els.uploadOverlay.classList.add('hidden');
            els.loadingOverlay.classList.remove('hidden');
            els.loadingText.textContent = `Processing ${files.length} file(s)...`;

            // Process sequentially to keep order
            for (const file of files) {
                if (file.type !== 'application/pdf') continue;

                try {
                    const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    const buffer = await file.arrayBuffer();
                    
                    // Load into PDF.js (for viewing)
                    const pdfJsDoc = await pdfjsLib.getDocument(buffer.slice(0)).promise;
                    
                    // Load into PDF-Lib (for manipulation)
                    const pdfDoc = await PDFDocument.load(buffer);

                    const source = {
                        id,
                        name: file.name,
                        pdfDoc,
                        pdfJsDoc,
                        pageCount: pdfJsDoc.numPages,
                        thumbnails: {} // Cache thumbnails per source
                    };

                    sources.push(source);
                    await renderSourceToGrid(source);

                } catch (err) {
                    console.error(err);
                    alert(`Error loading ${file.name}: ` + err.message);
                }
            }

            updateTotalSourceCount();
            
            els.loadingOverlay.classList.add('hidden');
            els.sourcePanel.classList.remove('hidden');
            els.queuePanel.classList.remove('hidden');
            els.resetBtn.classList.remove('hidden');
            
            // Re-init sortable to include new items if needed (mostly valid for queue)
            initSortable();
            initScrollHandlers();
            
            // Reset input so you can select the same file again if needed
            els.fileInput.value = '';
        }

        function updateTotalSourceCount() {
            const total = sources.reduce((acc, s) => acc + s.pageCount, 0);
            els.sourceCount.textContent = `${total} pgs / ${sources.length} docs`;
        }

        function toggleView() {
            isListView = !isListView;
            if (isListView) {
                els.sourceGrid.classList.remove('grid-cols-3', 'md:grid-cols-3', 'lg:grid-cols-4', 'xl:grid-cols-5');
                els.sourceGrid.classList.add('grid-cols-1', 'list-view');
                els.viewIcon.setAttribute('data-lucide', 'grid');
            } else {
                els.sourceGrid.classList.remove('grid-cols-1', 'list-view');
                els.sourceGrid.classList.add('grid-cols-3', 'md:grid-cols-3', 'lg:grid-cols-4', 'xl:grid-cols-5');
                els.viewIcon.setAttribute('data-lucide', 'list');
            }
            lucide.createIcons();
        }

        async function renderSourceToGrid(source) {
            // Add a Header for this file
            const header = document.createElement('div');
            // Updated Header Styling: Flex container with space-between
            header.className = 'col-span-full flex justify-between items-center gap-2 py-2 px-3 mt-4 border-b border-slate-200 bg-slate-50 rounded-t-lg';

			header.innerHTML = `
				<div class="flex items-center gap-2 overflow-hidden">
					<i data-lucide="file-text" class="h-4 w-4 text-slate-500 shrink-0"></i>
					<span class="text-xs font-bold text-slate-600 uppercase tracking-wider truncate" title="${source.name}">${source.name}</span>
				</div>
				<div class="flex items-center gap-3 shrink-0">
					<span class="font-mono text-[10px] text-slate-400">${source.pageCount} pgs</span>
					<button onclick="addSourcePages('${source.id}')" class="text-[10px] font-bold bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 hover:border-blue-300 px-2 py-1 rounded transition-colors shadow-sm flex items-center gap-1">
						<i data-lucide="copy-plus" class="h-3 w-3"></i> Add All
					</button>
				</div>
			`;
			els.sourceGrid.appendChild(header);

            const frag = document.createDocumentFragment();

            // Intersection Observer for lazy loading thumbnails
            if (!observer) {
                observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const card = entry.target;
                            const sId = card.dataset.sourceId;
                            const pIdx = parseInt(card.dataset.pageIndex);
                            const img = card.querySelector('img');
                            
                            generateThumbnail(sId, pIdx + 1).then(url => {
                                img.src = url;
                                img.classList.remove('opacity-0');
                            });
                            obs.unobserve(card);
                        }
                    });
                }, { root: els.sourceContainer, rootMargin: '100px' });
            }

            for (let i = 1; i <= source.pageCount; i++) {
                const template = document.getElementById('sourcePageTemplate').content.cloneNode(true);
                const pageIndex = i - 1;

                const card = template.querySelector('.pdf-page-card');
                const pageNum = template.querySelector('.page-num');
                const pageNumText = template.querySelector('.page-num-text');
                const input = template.querySelector('.copies-input');
                const addBtn = template.querySelector('.add-btn');
                const previewBtn = template.querySelector('.preview-btn');

                card.dataset.sourceId = source.id;
                card.dataset.pageIndex = pageIndex;
                
                pageNum.textContent = i;
                pageNumText.textContent = i;
                
                const add = () => {
                    const count = parseInt(input.value) || 1;
                    addToQueue(source.id, pageIndex, count);
                    card.classList.add('ring-2', 'ring-blue-500');
                    setTimeout(() => card.classList.remove('ring-2', 'ring-blue-500'), 200);
                };
                
                card.onclick = add;
                addBtn.onclick = (e) => { e.stopPropagation(); add(); };
                previewBtn.onclick = (e) => { e.stopPropagation(); openPreview(source.id, pageIndex); };

                frag.appendChild(template);
                observer.observe(card);
            }
            els.sourceGrid.appendChild(frag);
            header.scrollIntoView({ behavior: 'smooth', block: 'start' });
            lucide.createIcons();
        }

        async function generateThumbnail(sourceId, num) {
            const source = sources.find(s => s.id === sourceId);
            if (!source || source.thumbnails[num]) return source?.thumbnails[num];

            const page = await source.pdfJsDoc.getPage(num);
            const viewport = page.getViewport({ scale: 0.25 }); 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({ canvasContext: ctx, viewport }).promise;
            
            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    source.thumbnails[num] = url;
                    resolve(url);
                });
            });
        }

        // --- Multi-Source Add All ---
        async function addAllPages() {
            if (sources.length === 0) return;
            
            if (!await showConfirm(`Add all pages from ALL ${sources.length} documents?`)) return;

            els.addAllBtn.disabled = true;
			
			try {
				for (const source of sources) {
					const count = source.pageCount;
					const BATCH_SIZE = 50;

					for (let i = 0; i < count; i += BATCH_SIZE) {
						const limit = Math.min(i + BATCH_SIZE, count);
						for (let j = i; j < limit; j++) {
							const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
							const qItem = { id, sourceId: source.id, pageIndex: j };
							queue.push(qItem);
							renderQueueItem(qItem, false);
						}
						updateStats();
						await new Promise(r => setTimeout(r, 0));
					}
				}
				lucide.createIcons();
			}
            catch (err) {
				console.error("Error adding pages:", err);
			} finally {
				// This runs NO MATTER WHAT, ensuring the button works again
				setTimeout(() => {
					els.queueContainer.scrollTop = els.queueContainer.scrollHeight;
					els.addAllBtn.disabled = false;
				}, 50);
			}
        }
		
		async function addSourcePages(sourceId) {
			const source = sources.find(s => s.id === sourceId);
			if(!source) return;

			// Optional: Confirmation for large files only
			if(source.pageCount > 50 && !await showConfirm(`Add all ${source.pageCount} pages from "${source.name}"?`)) return;

			// Find the button to give visual feedback
			// We use a safe selector to avoid errors
			const btn = document.querySelector(`button[onclick="addSourcePages('${sourceId}')"]`);
			const originalContent = btn ? btn.innerHTML : '';
    
			if(btn) {
				btn.disabled = true;
				btn.innerHTML = `<div class="spinner border-t-blue-600 w-3 h-3 border-2"></div>`;
			}

			// Optimization: Batch Process to prevent UI freeze
			const BATCH_SIZE = 50;
			for (let i = 0; i < source.pageCount; i += BATCH_SIZE) {
				const limit = Math.min(i + BATCH_SIZE, source.pageCount);
				for (let j = i; j < limit; j++) {
					const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
					const qItem = { id, sourceId: source.id, pageIndex: j };
					queue.push(qItem);
					// Pass 'false' to delay icon rendering until the end
					renderQueueItem(qItem, false); 
				}
				updateStats();
				// Yield to main thread
				await new Promise(r => setTimeout(r, 0));
			}

			// Finalize
			lucide.createIcons();
			if(btn) {
				btn.disabled = false;
				btn.innerHTML = originalContent;
			}
    
			// Auto-scroll to the bottom of the queue
			setTimeout(() => {
				els.queueContainer.scrollTop = els.queueContainer.scrollHeight;
			}, 50);
		}

        function addToQueue(sourceId, pageIndex, count) {
            for(let i=0; i<count; i++) {
                const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                const qItem = { id, sourceId, pageIndex };
                queue.push(qItem);
                renderQueueItem(qItem);
            }
            updateStats();
            els.queueContainer.scrollTop = els.queueContainer.scrollHeight;
        }

        function renderQueueItem(qItem, renderIcons = true) {
            const template = document.getElementById('queueItemTemplate').content.cloneNode(true);
            const item = template.querySelector('.queue-item');
            const source = sources.find(s => s.id === qItem.sourceId);
    
            item.dataset.id = qItem.id;
            template.querySelector('.origin-num').textContent = qItem.pageIndex + 1;
            
            // Update filename label
            const fileLabel = template.querySelector('.file-name');
            if (source) fileLabel.textContent = source.name;
    
            // Set thumbnail
            if(source && source.thumbnails[qItem.pageIndex + 1]) {
                template.querySelector('img').src = source.thumbnails[qItem.pageIndex + 1];
            }

            template.querySelector('.remove-btn').onclick = () => {
                item.remove();
                updateQueueFromDOM();
            };

            const previewTrigger = template.querySelector('.preview-trigger');
            if(previewTrigger) {
                previewTrigger.onclick = (e) => {
                    e.stopPropagation();
                    openPreview(qItem.sourceId, qItem.pageIndex);
                };
            }

            els.queueList.appendChild(template);
            if (renderIcons) lucide.createIcons();
        }

        // --- Multi-Source Download Logic ---
        async function downloadPDF() {
            if(queue.length === 0) return;
            
            const btn = els.downloadBtn;
            const initialText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner border-t-white w-4 h-4"></div> Processing...`;
            btn.disabled = true;

            try {
                const newDoc = await PDFDocument.create();

				// Use the first document as the "master" for metadata
				const masterDoc = sources[0]?.pdfDoc;
					if (masterDoc) {
    					newDoc.setTitle(masterDoc.getTitle() || '');
    					newDoc.setAuthor(masterDoc.getAuthor() || '');
    					newDoc.setSubject(masterDoc.getSubject() || '');
    					newDoc.setCreator(masterDoc.getCreator() || '');
					}
                
                // Group contiguous pages from the same source to optimize copying
                // This is a big performance boost over copying one by one
                let currentChunk = [];
                let currentSourceId = null;

                const processChunk = async () => {
                    if (currentChunk.length === 0) return;
                    
                    const source = sources.find(s => s.id === currentSourceId);
                    if (source) {
                        const copiedPages = await newDoc.copyPages(source.pdfDoc, currentChunk);
                        copiedPages.forEach(p => newDoc.addPage(p));
                    }
                    currentChunk = [];
                };

                for (const item of queue) {
                    // If source changes, process the previous chunk
                    if (item.sourceId !== currentSourceId) {
                        await processChunk();
                        currentSourceId = item.sourceId;
                    }
                    currentChunk.push(item.pageIndex);
                }
                // Process final chunk
                await processChunk();

                const pdfBytes = await newDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `combined_${Date.now()}.pdf`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);

            } catch (e) {
                console.error(e);
                alert('Failed to generate PDF: ' + e.message);
            } finally {
                btn.innerHTML = initialText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // --- Preview Logic ---
        function openPreview(sourceId, index) {
            currentPreviewSourceId = sourceId;
            currentPreviewIndex = index;
            els.previewModal.classList.remove('hidden');
            void els.previewModal.offsetWidth; 
            els.previewModal.classList.add('modal-active');
            renderPreviewCanvas();
        }

        function closePreview() {
            els.previewModal.classList.remove('modal-active');
            setTimeout(() => els.previewModal.classList.add('hidden'), 200);
        }

        function changePreviewPage(delta) {
            const source = sources.find(s => s.id === currentPreviewSourceId);
            if (!source) return;

            const newIndex = currentPreviewIndex + delta;
            if (newIndex >= 0 && newIndex < source.pageCount) {
                currentPreviewIndex = newIndex;
                renderPreviewCanvas();
            }
        }

        async function renderPreviewCanvas() {
            const source = sources.find(s => s.id === currentPreviewSourceId);
            if (!source) return;

            els.previewSpinner.style.display = 'block';
            els.previewPageNum.textContent = `(${currentPreviewIndex + 1} of ${source.pageCount})`;
            
            const page = await source.pdfJsDoc.getPage(currentPreviewIndex + 1);
            const scale = window.innerWidth > 1000 ? 1.5 : 1.0; 
            const viewport = page.getViewport({ scale: scale });
            const canvas = els.previewCanvas;
            const ctx = canvas.getContext('2d');
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: ctx, viewport }).promise;
            els.previewSpinner.style.display = 'none';
        }

        function initSortable() {
            if(sortable) sortable.destroy();
            sortable = new Sortable(els.queueList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: updateQueueFromDOM
            });
        }
		
		function updateQueueFromDOM() {
    		// 1. Create a quick lookup map (O(N))
    		const queueMap = new Map(queue.map(item => [item.id, item]));
    		const newQueue = [];
    
    		// 2. Iterate DOM and look up directly (O(N))
    		document.querySelectorAll('.queue-item').forEach(el => {
        		const id = el.dataset.id;
        		const item = queueMap.get(id); // Instant lookup
        		if (item) newQueue.push(item);
    		});

    		queue = newQueue;
    		updateStats();
		}

        function updateStats() {
            const count = queue.length;
            els.totalNewPages.textContent = count;
            els.downloadBtn.disabled = count === 0;
            els.emptyState.classList.toggle('hidden', count > 0);
        }

        async function clearQueue() {
            if(!await showConfirm('Clear all pages?', 'Clear All', true)) return;
            queue = [];
            els.queueList.innerHTML = '';
            updateStats();
        }

        async function resetApp() {
            if(!await showConfirm('Reset everything? This will remove all loaded documents.', 'Reset App', true)) return;
            
            // Cleanup memory
            sources.forEach(s => {
                Object.values(s.thumbnails).forEach(url => URL.revokeObjectURL(url));
            });
            sources = [];
            queue = [];
            
            if(observer) observer.disconnect();
            observer = null;
            
            els.sourceGrid.innerHTML = '';
            els.queueList.innerHTML = '';
            els.fileInput.value = '';
            
            els.sourcePanel.classList.add('hidden');
            els.queuePanel.classList.add('hidden');
            els.resetBtn.classList.add('hidden');
            els.uploadOverlay.classList.remove('hidden');
            els.loadingOverlay.classList.add('hidden');
            
            updateStats();
        }

        // --- Custom Confirm Logic ---
        function showConfirm(message, confirmButtonText = 'Confirm', isDestructive = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const msgEl = document.getElementById('confirmMessage');
                const cancelBtn = document.getElementById('confirmCancelBtn');
                const okBtn = document.getElementById('confirmOkBtn');

                // Set content
                msgEl.textContent = message;
                okBtn.textContent = confirmButtonText;

                // Styling for destructive actions (Reset/Clear)
                if (isDestructive) {
                    okBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    okBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    okBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    okBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }

                // Show Modal
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.add('modal-active');
                });

                // Handlers
                const close = (result) => {
                    modal.classList.remove('modal-active');
                    setTimeout(() => modal.classList.add('hidden'), 200);
                    resolve(result);
            
                    // Clean up listeners
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                    modal.onclick = null; // Clean up backdrop listener
                };

                cancelBtn.onclick = () => close(false);
                okBtn.onclick = () => close(true);

                // NEW: Close if clicking the background (backdrop)
                modal.onclick = (e) => {
                    if (e.target === modal) close(false);
                };
            });
        }

        function initScrollHandlers() {
                    setupScrollLogic('sourceContainer', 'sourceScrollBtn', 'sourceScrollDown', 'sourceScrollUp');
                    setupScrollLogic('queueContainer', 'queueScrollBtn', 'queueScrollDown', 'queueScrollUp');
                }

        function setupScrollLogic(containerId, btnId, downId, upId) {
            const container = document.getElementById(containerId);
            const btn = document.getElementById(btnId);
            const downSpan = document.getElementById(downId);
            const upSpan = document.getElementById(upId);

            if (!container || !btn) return;

            const updateState = () => {
                // 1. Show button only if scrollable
                const isScrollable = container.scrollHeight > container.clientHeight + 20; // +20 buffer
                if (!isScrollable) {
                    btn.classList.add('opacity-0', 'pointer-events-none');
                    return;
                }
                
                btn.classList.remove('opacity-0', 'pointer-events-none');

                // 2. Toggle Visibility based on position
                const isNearTop = container.scrollTop < 50;
                
                if (isNearTop) {
                    // Show Down, Hide Up
                    downSpan.classList.remove('hidden');
                    upSpan.classList.add('hidden');
                } else {
                    // Hide Down, Show Up
                    downSpan.classList.add('hidden');
                    upSpan.classList.remove('hidden');
                }
                // No need to call lucide.createIcons() here anymore!
            };

            container.addEventListener('scroll', () => requestAnimationFrame(updateState));
            new ResizeObserver(updateState).observe(container);
        }

        function toggleScroll(type) {
            const container = document.getElementById(type === 'source' ? 'sourceContainer' : 'queueContainer');
            if (!container) return;

            const isNearTop = container.scrollTop < 50;

            container.scrollTo({
                top: isNearTop ? container.scrollHeight : 0,
                behavior: 'smooth'
            });
        }

    </script>

    <div class="fixed bottom-0 left-0 right-0 p-4 flex justify-between items-end pointer-events-none text-xs text-gray-400 font-mono z-50">
        <div class="pointer-events-auto">
            v1.1.2
        </div>
        
       <!-- 
		<div class="pointer-events-auto bg-white/80 backdrop-blur-sm px-2 py-1 rounded border border-gray-200 shadow-sm">
            Beta channel: 
            <a href="https://ceqell.github.io/pdf-duplicator-combiner/beta" class="text-blue-600 hover:text-blue-800 underline transition-colors">
               ceqell.github.io/pdf-duplicator-combiner/beta
            </a>
        </div>
    </div> 
		-->

</body>
</html>








